@page "/clientes"
@attribute [StreamRendering]
@inject HttpClient _http
@rendermode @(new InteractiveServerRenderMode (prerender:false))
@inject NavigationManager Topag
@inject Cliente _cli

<PageTitle>Clientes</PageTitle>

<h3>Clientes </h3>

<div class="container">

    @if (clientes == null)
    {
        <p><em>Aguarde...</em></p>
    }
    else
    {
        <button class="btn-sm btn-primary" style="font-style:italic" @onclick="NewCliente">+ Novo Cliente</button>

        <table class="table col-md-12">
            <thead>
                <tr>
                    <th>Nome Cliente</th>
                    <th>Nro Telefone</th>
                    <th>Contato     </th>
                    <th>Data Cadastro</th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in clientes)
                {
                    <tr>
                        <td>@item.NomeCliente</td>
                        <td>@item.NroTelefone</td>
                        <td>@item.NomeContato</td>
                        <td>@DateOnly.FromDateTime(@item.DataCadastro)</td>
                        <td><button class="btn-sm btn-warning border-dark" @onclick="(() => Seleciona(item))">Alterar</button></td>
                        <td><button class="btn-sm btn-danger border-dark" @onclick="(() => Confirma(item))">Apaga</button></td>
                        <td><button class="btn-sm btn-info border-dark" @onclick="@(() => ConsultaCliente(item))">Consulta</button></td>
                        <td><button class="btn-sm btn-primary border-dark" @onclick="(() => Seleciona(item))">Pedido</button></td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@if (Sim)
{<div class="container align-content-center">
        <div class="alert alert-danger alert-dismissible" role="alert">
            <strong>Holy guacamole!</strong> You should check in on some of those fields below.

            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" @onclick="Sair"></button>
        </div>
    </div>
}

@*<button class="btn-sm btn-secondary" @onclick="@(() => Envia())">Banco de Dados</button>*@

<Mensagens @ref="Mensa" BotaoTrue=@MsgBotton Titulo=@Titul Mostra=@Mostr Msg=@Mensag Confirma=@Confirm EventoRetorno="(() => ReturnFuncao())"> </Mensagens>

@code
 {

    Mensagens? Mensa = null;

    public bool Confirm { get; set; } = false;
    public string Mensag { get; set; } = string.Empty;
    public string Titul { get; set; } = string.Empty;
    public string Mostr { get; set; } = "none";
    public string MsgBotton { get; set; } = string.Empty;
    public bool Sim { get; set; } =false;


    public List<Cliente>? clientes = null!;
    public Cliente Objcliente = null!;
    public int IdCliente { get; set; } = 0;
    public string? NomeCliente { get; set; } = string.Empty;
    public Cliente Cli = new();

    public void Sair()
    {
        Sim = false;
    }

    protected override async Task OnInitializedAsync()
    {
        clientes = await _http.GetFromJsonAsync<List<Cliente>>(@"/api/v1/clientes");
    }

    public void Confirma(Cliente cli)
    {
        IdCliente = cli.ClienteId;
        NomeCliente = cli.NomeCliente;
        Mensag = $"Cliente: {NomeCliente}";
        Titul = "Confirma Exclusão?";
        Mostr = "block";
        MsgBotton = "Exclui";
    }

    public async Task Envia()
    {
        Cliente cli = new Cliente
        {
            NomeCliente = "Angeliazer Rigon  da Silva",
            CpfCliente = "0",
            CnpjCliente = "0",
            TipoCliente = ETipoCliente.Fisica,
            NroTelefone = "21967453273",
            NomeContato = "Yago",
            LimiteCredito = 25000,
            Enderecos = new List<Endereco>
{
                new Endereco {
                    NomeRua="Rua Goiás",
                    Numero = "216",
                    Bairro = "Mutuá",
                    Cidade = "São Gonçalo",
                    Estado = EEstado.DF,
                    Cep = "24460170",
                    TipoEnd = ETipoEndereco.Entrega
                },
                new Endereco
                {
                    NomeRua = "Rua Santos da Cruz",
                    Numero = "216",
                    Bairro = "Mutuá",
                    Cidade = "São Gonçalo",
                    Estado = EEstado.DF,
                    Cep = "24460170",
                    TipoEnd = ETipoEndereco.Faturamento
                }
            }
        };

        var result = await _http.PostAsJsonAsync<Cliente>("/api/v1/clientes", cli);
    }

    public void ConsultaCliente(Cliente cliente)
    {
        _cli = cliente;
        Topag.NavigateTo("/concliente");
    }

    public async Task ReturnFuncao()
    {
        if (Mensa?.Confirma == true)
        {
            await ApagaRegistro();
        }
        Confirm = false;
        Mostr = "none";
    }

    public async Task ApagaRegistro()
    {
        await _http.DeleteFromJsonAsync<Cliente>($@"/api/v1/clientes/{IdCliente}");
        await OnInitializedAsync();
    }

    public void Seleciona(Cliente cliente)
    {

    }
    public void NewCliente()
    {
        Topag.NavigateTo("/newcliente");
    }
}
